#!/usr/bin/env python
# vim:set sw=4 et:
#

"""
Dump contents of database to stdout. Database can be any file that the anydbm
module can read. Included with warcprox because it's useful for inspecting a
deduplication database or a playback index database, but it is a generic tool.
"""

try:
    import dbm
    whichdb = dbm.whichdb
except:
    import anydbm 
    dbm = anydbm
    from whichdb import whichdb

import sys
import os.path

if __name__ == "__main__":
    if len(sys.argv) != 2:
        sys.stderr.write("usage: {} DBM_FILE\n".format(sys.argv[0]))
        exit(1)

    filename = sys.argv[1]
    file_location = sys.argv[1]
    which = whichdb(filename)

    # if which returns none and the file does not exist, print usage line
    if which == None and not os.path.exists(sys.argv[1]):
        sys.stderr.write('No such file {}\n\n'.format(sys.argv[1]))
        sys.stderr.write("usage: {} DBM_FILE\n".format(sys.argv[0]))
        exit(1)

    # covers case where an ndbm is checked with its extension & identified incorrectly
    elif 'bsd' in which:
        correct_file = filename.split(".db")[0]
        correct_which = whichdb(correct_file)
        if correct_which == ('dbm' or 'dbm.ndbm'):
            filename = correct_file
            which = correct_which

    elif which == '':
        sys.stderr.write("{} is an unrecognized database type\n".format(sys.argv[1]))
        exit(1)

    print('{} is a {} db'.format(filename, which))

    db = dbm.open(filename, 'r')

    for key in db.keys():
        print("{}:{}".format(key, db[key]))
